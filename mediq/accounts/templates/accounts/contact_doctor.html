{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chat with Dr. {{ selected.name }}</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <style>
    /* —— Accessibility Modes —— */
    {% if request.session.high_contrast %}
      body { background: #000; color: #fff; font-family: {% if request.session.alternative_font %}'Oswald'{% else %}'Roboto'{% endif %},sans-serif; font-size: {{ request.session.font_size|default:"22" }}px; }
      .card { background: #000; border-color: #ffea00; }
      .btn-primary { background: #ffea00; color: #000; border: none; }
    {% elif request.session.dark_mode %}
      body { background: #333; color: #fff; font-family: {% if request.session.alternative_font %}'Oswald'{% else %}'Roboto'{% endif %},sans-serif; font-size: {{ request.session.font_size|default:"20" }}px; }
      .card { background: #222; border-color: #007BFF; }
      .btn-primary { background: #007BFF; color: #fff; border: none; }
    {% else %}
      body {
        background: #f4f4f4;
        color: #333;
        font-family: {% if request.session.alternative_font %}"Oswald"{% else %}Arial{% endif %},sans-serif;
        font-size: {{ request.session.font_size|default:"16" }}px;
      }
      .card {
        background: #fff;
        border: 2px solid #007BFF;
        box-shadow: 0 2px 6px rgba(0, 123, 255, 0.1);
      }
      .btn-primary {
        background: #007BFF;
        color: #fff;
        border: none;
      }
      .list-group-item.active {
        background-color: #007BFF;
        border-color: #007BFF;
      }
    {% endif %}

    .doctor-preview img {
      width: 96px;
      height: 96px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #ccc;
    }
  </style>
</head>
<body>
<main class="container py-5" role="main">

  <!-- Back link to patient dashboard -->
  <p>
    <a href="{% url 'dashboard' %}" class="btn btn-link">
      <i class="fas fa-arrow-left"></i> Back to Dashboard
    </a>
  </p>

  <div class="d-flex align-items-center mb-4 doctor-preview">
    <img src="{{ selected.img_url }}"
         alt="Dr. {{ selected.name }}"
         onerror="this.src='{% static 'accounts/images/default.jpg' %}'">
    <h1 class="ml-3 mb-0">Chat with Dr. {{ selected.name }}</h1>
  </div>

  <div class="row">
    <!-- Sidebar: list of doctors -->
    <div class="col-md-4 mb-4">
      <ul class="list-group" aria-label="Choose doctor to chat">
        {% for doc in doctors %}
          <li class="list-group-item {% if doc.id == selected.id %}active{% endif %}">
            <a href="?doctor={{ doc.id }}"
               class="d-flex align-items-center text-decoration-none {% if doc.id == selected.id %}text-white{% endif %}">
              <img src="{{ doc.img_url }}"
                   alt="Dr. {{ doc.name }}"
                   class="rounded-circle mr-2"
                   width="40" height="40"
                   onerror="this.src='{% static 'accounts/images/default.jpg' %}'">
              <span>{{ doc.name }}</span>
            </a>
          </li>
        {% endfor %}
      </ul>
    </div>

    <!-- Chat area -->
    <div class="col-md-8">
      <!-- History -->
      <div class="card mb-4 p-3" style="height:400px; overflow-y:auto;" aria-live="polite">
        {% if chat_history %}
          {% for msg in chat_history %}
            <div class="mb-2 {% if msg.sender_user == user %}text-right{% else %}text-left{% endif %}">
              <div class="d-inline-block px-3 py-2 rounded
                          {% if msg.sender_user == user %}bg-primary text-white{% else %}bg-light text-dark{% endif %}">
                {{ msg.content|linebreaksbr }}
                <br>
                <small class="d-block text-muted">{{ msg.timestamp|date:"M d, H:i" }}</small>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <p class="text-muted"><em>No messages yet. Send your first note below ⬇️</em></p>
        {% endif %}
      </div>

      <!-- Send new message -->
      <form method="post" novalidate>
        {% csrf_token %}
        <!-- Hidden field to carry which doctor we’re messaging -->
        <input type="hidden" name="receiver_doctor" value="{{ selected.id }}">

        <div class="form-group">
          {{ form.content.label_tag }}
          {{ form.content }}
          {{ form.content.errors }}
        </div>
        <div class="text-right">
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-paper-plane mr-1"></i> Send
          </button>
        </div>
      </form>
    </div>
  </div>
</main>
</body>
</html>
